{{- $fullName := include "llm-config-manager.fullname" . -}}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $fullName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "llm-config-manager.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
  {{- with .Values.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.service.type }}
  {{- if .Values.service.sessionAffinity }}
  sessionAffinity: {{ .Values.service.sessionAffinity }}
  {{- end }}
  {{- if .Values.service.sessionAffinityConfig }}
  sessionAffinityConfig:
    {{- toYaml .Values.service.sessionAffinityConfig | nindent 4 }}
  {{- end }}
  ports:
    - port: {{ .Values.service.port }}
      targetPort: http
      protocol: TCP
      name: http
    - port: {{ .Values.service.metricsPort }}
      targetPort: metrics
      protocol: TCP
      name: metrics
  selector:
    {{- include "llm-config-manager.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: api

{{- if .Values.loadBalancer.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $fullName }}-external
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "llm-config-manager.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
  {{- with .Values.loadBalancer.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  ports:
    - port: 443
      targetPort: http
      protocol: TCP
      name: https
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "llm-config-manager.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: api
{{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ $fullName }}-headless
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "llm-config-manager.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
spec:
  type: ClusterIP
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
    - port: {{ .Values.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "llm-config-manager.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: api
